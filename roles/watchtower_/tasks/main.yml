- name: "Ensure watchtower stack is {{ service_watchtower }}"
  docker_compose:
    project_name: watchtower
    definition:
      version: "3.7"
      services:
        app:
          container_name: watchtower
          hostname: "{{ inventory_hostname }}"
          image: containrrr/watchtower
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
          environment:
            - TZ={{ timezone }}
            - WATCHTOWER_CLEANUP=true
            - WATCHTOWER_LIFECYCLE_HOOKS=1 # Enable pre/post-update scripts
            - WATCHTOWER_HTTP_API_UPDATE=true
            - "WATCHTOWER_HTTP_API_TOKEN={{ watchtower_http_token }}"
            - WATCHTOWER_HTTP_API_PERIODIC_POLLS=true
            - WATCHTOWER_NOTIFICATIONS=shoutrrr
#            - "WATCHTOWER_NOTIFICATION_URL=telegram://{{ telegram_bot_token }}@telegram/?channels={{ telegram_channel_id }}"
          ports:
            - 8097:8097
          labels:
            # general settings
            - "traefik.enable=true"
            - "traefik.docker.network=traefik_net"
            - "traefik.http.services.watchtower.loadbalancer.server.port=8080"
            # local router
            - "traefik.http.routers.watchtower_direct.EntryPoints=web"
            - "traefik.http.routers.watchtower_direct.rule=Host(`watchtower`)"
            - "traefik.http.routers.watchtower_direct.service=watchtower"
      networks:
        default:
          external:
            name: traefik_net
    recreate: "{{ (service_watchtower == 'started') | ternary('smart', 'always') }}"
    state: "{{ (service_watchtower in ['started', 'stopped', 'restarted']) | ternary('present', 'absent') }}"
    stopped: "{{ service_watchtower == 'stopped' }}"
    restarted: "{{ service_watchtower == 'restarted' }}"
    remove_images: "{{ (service_watchtower == 'purged') | ternary('all', 'local') }}"
    remove_orphans: "{{ service_watchtower == 'purged' }}"
  register: watchtower_stack


# to disable a container
#LABEL com.centurylinklabs.watchtower.enable="false"
# to trigger a scan
#curl -H "Authorization: Bearer {{ watchtower_http_token }}" http://watchtower/v1/update